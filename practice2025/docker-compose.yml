services:
  mediawiki:
    image: mediawiki:1.39
    container_name: support-mediawiki
    restart: unless-stopped
    depends_on:
      - postgres-mediawiki
      - opensearch-node1
    ports:
      - "8080:80"
    volumes:
      - ./extensions:/var/www/html/extensions
      - ./scripts/:/var/www/html/scripts
      - ./LocalSettings.php:/var/www/html/LocalSettings.php
    command: >
      bash -lc "
        apt-get update && \
        apt-get install -y libpq-dev p7zip-full unzip && \
        docker-php-ext-install mysqli pdo pdo_mysql pgsql pdo_pgsql && \
        curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/bin --filename=composer && \
        exec apache2-foreground
      "
    environment:
      - MEDIAWIKI_DB_TYPE=postgres
      - MEDIAWIKI_DB_HOST=postgres-mediawiki
      - MEDIAWIKI_DB_PORT=5432
      - MEDIAWIKI_DB_NAME=mediawiki
      - MEDIAWIKI_DB_USER=wikiuser
      - MEDIAWIKI_DB_PASSWORD=wikipass
      - MEDIAWIKI_ADMIN_USER=admin
      - MEDIAWIKI_ADMIN_PASS=adminpass
      - MEDIAWIKI_SITE_NAME=KnowledgeBase
      - REDMINE_URL=http://redmine:3000
    networks:
      - support_net

  postgres-mediawiki:
    image: postgres:15-alpine
    container_name: support-postgres-mediawiki
    restart: unless-stopped
    volumes:
      - postgres_mediawiki_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=mediawiki
      - POSTGRES_USER=wikiuser
      - POSTGRES_PASSWORD=wikipass
    networks:
      - support_net

  opensearch-node1:
    image: opensearchproject/opensearch:latest
    container_name: support-opensearch1
    environment:
      - cluster.name=opensearch-cluster
      - node.name=opensearch-node1
      - discovery.seed_hosts=opensearch-node1,opensearch-node2
      - cluster.initial_cluster_manager_nodes=opensearch-node1,opensearch-node2
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms256m -Xmx256m"
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=Asuadmin123!
      - plugins.security.ssl.http.enabled=false
      - plugins.security.disabled=true
      - compatibility.override_main_response_version=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch_data1:/usr/share/opensearch/data
    ports:
      - 9200:9200
    networks:
      - support_net

  opensearch-node2:
    image: opensearchproject/opensearch:latest
    container_name: support-opensearch2
    environment:
      - cluster.name=opensearch-cluster
      - node.name=opensearch-node2
      - discovery.seed_hosts=opensearch-node1,opensearch-node2
      - cluster.initial_cluster_manager_nodes=opensearch-node1,opensearch-node2
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms256m -Xmx256m"
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=Asuadmin123!
      - plugins.security.ssl.http.enabled=false
      - plugins.security.disabled=true
      - compatibility.override_main_response_version=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - opensearch_data2:/usr/share/opensearch/data
    networks:
      - support_net

  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:latest
    container_name: support-opensearch-dashboards
    ports:
      - 5601:5601
    environment:
      OPENSEARCH_HOSTS: '["http://opensearch-node1:9200","http://opensearch-node2:9200"]'
      DISABLE_SECURITY_DASHBOARDS_PLUGIN: true
    networks:
      - support_net

  redmine:
    image: redmine:5.0
    container_name: support-redmine
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - redmine_data:/usr/src/redmine/files
      - redmine_plugins:/usr/src/redmine/plugins
    environment:
      - REDMINE_DB_POSTGRES=postgres-redmine
      - REDMINE_DB_DATABASE=redmine
      - REDMINE_DB_USERNAME=redmine
      - REDMINE_DB_PASSWORD=redmine
      - RAILS_ENV=production
      - SECRET_KEY_BASE=someveryverylongsecretkey123456789012345678901234567890
    depends_on:
      - postgres-redmine
    networks:
      - support_net

  postgres-redmine:
    image: postgres:15-alpine
    container_name: support-postgres-redmine
    restart: unless-stopped
    volumes:
      - postgres_redmine_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=redmine
      - POSTGRES_USER=redmine
      - POSTGRES_PASSWORD=redmine
    networks:
      - support_net

networks:
  support_net:
    driver: bridge

volumes:
  mediawiki_data:
  postgres_mediawiki_data:
  postgres_redmine_data:
  opensearch_data1:
  opensearch_data2:
  redmine_data:
  redmine_plugins: